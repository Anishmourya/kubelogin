# Acceptance Test

This is an acceptance test for verifying behavior of kubelogin
using a real Kubernetes cluster and OpenID Connect provider.

TODO: components diagram


## How it works

The acceptance test is performed by the following steps:

1. Create a Kubernetes cluster using Kind.
1. Deploy a Dex server to the cluster.
1. Deploy a cluster role binding to the cluster.
1. Import the CA certificate.
1. Run kubectl.
1. Open the browser, and enter the username and password.


### Kubernetes OpenID Connect authentication

It sets the extra arguments (see [cluster.yaml](cluster.yaml)) to Kubernetes API server,
e.g. the issuer, client ID and secret.

### Certificate

It imports the CA certificate of Kubernetes cluster generated by Kind.



- Kubernetes requires an issuer of HTTPS for OpenID Connect authentication.



## Run locally

You need to set up Docker and Kind.

Run the test:

```shell script
# make accessible by the issuer domain name
echo "127.0.0.1 server.dex.svc.cluster.local" | sudo tee -a /etc/hosts

# run the test
make
```

Clean up:

```shell script
# delete the Kubernets cluster
make delete-cluster

# remove the CA certificate from the keychain (macos)
security delete-certificate -c kubernetes -t ~/Library/Keychains/login.keychain-db

# remove the issuer domain name
sudo vi /etc/hosts
```
